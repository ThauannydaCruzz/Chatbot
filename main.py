import os
import json
import random
from datetime import datetime
import pywhatkit as kit
from rapidfuzz import process, fuzz
try:
    from googlesearch import search
except ImportError:
    search = None

# Utilit√°rios de leitura e escrita
def ler_json(path):
    if not os.path.exists(path):
        return []
    with open(path, "r", encoding="utf-8") as f:
        return json.load(f)

def salvar_json(obj, path):
    with open(path, "w", encoding="utf-8") as f:
        json.dump(obj, f, ensure_ascii=False, indent=2)

# Arquivos de dados
FAQ_FILE = "faq_memoria.json"
AMEACAS_FILE = "ameacas_explicacoes_solucoes.json"
SITES_FILE = "sites_maliciosos.json"
LOGS_FILE = "logs.json"

faq = ler_json(FAQ_FILE)
ameacas = ler_json(AMEACAS_FILE)
sites = ler_json(SITES_FILE)
logs = ler_json(LOGS_FILE)
historico = []

# Respostas b√°sicas
cumprimentos = [
    "Oi! Tudo bem por a√≠? üòä",
    "Ol√°! Como posso ajudar hoje?",
    "E a√≠, tranquilo? Em que posso te ajudar?"
]
despedidas = [
    "Tchau! Fique seguro(a)! üëã",
    "At√© mais! Proteja seus dados! üõ°Ô∏è",
    "Se cuida! Qualquer coisa, s√≥ chamar. üòÑ"
]
respostas_basicas = {
    "como voc√™ est√°": [
        "Estou √≥timo, obrigado por perguntar! E voc√™?",
        "Funcionando a todo vapor! E contigo?",
        "De boas, sempre pronto pra ajudar."
    ],
    "quem √© voc√™": [
        "Sou o Aegis, especialista em seguran√ßa virtual! Pronto para proteger voc√™ e sua loja. üòé",
        "Eu sou o Aegis, seu consultor digital para ciberseguran√ßa.",
        "Aegis na √°rea! Seu escudeiro virtual contra amea√ßas."
    ],
    "qual seu nome": [
        "Meu nome √© Aegis!",
        "Pode me chamar de Aegis.",
        "Sou o Aegis, prazer!"
    ],
    "qual sua fun√ß√£o": [
        "Minha miss√£o √© ajudar voc√™ a entender e se proteger de amea√ßas digitais, explicar boas pr√°ticas, analisar riscos e orientar em emerg√™ncias.",
        "Sou seu assistente especialista em ciberseguran√ßa, pronto para explicar, proteger e agir junto com sua equipe.",
    ],
    "obrigado": [
        "Por nada! üòâ",
        "Disponha!",
        "Tamo junto!"
    ],
    "qual o dia de hoje": [
        f"Hoje √© {datetime.now().strftime('%d/%m/%Y')}.",
        f"Estamos no dia {datetime.now().strftime('%d/%m/%Y')}.",
        f"O calend√°rio diz: {datetime.now().strftime('%d/%m/%Y')}."
    ],
    "que dia √© hoje": [
        f"Hoje √© {datetime.now().strftime('%d/%m/%Y')}.",
        f"Estamos no dia {datetime.now().strftime('%d/%m/%Y')}.",
        f"O calend√°rio diz: {datetime.now().strftime('%d/%m/%Y')}."
    ],
    "que horas s√£o": [
        f"Agora s√£o {datetime.now().strftime('%H:%M')} (hor√°rio do servidor).",
        "Deixa eu ver... s√£o " + datetime.now().strftime('%H:%M') + "!",
        f"Rel√≥gio marcando: {datetime.now().strftime('%H:%M')}."
    ],
    "qual a temperatura": [
        "Eu ainda n√£o sei ver previs√£o do tempo üòÖ, mas posso te ajudar com ciberseguran√ßa!",
        "Ainda n√£o tenho acesso √† temperatura, mas posso proteger seus dados!",
        "Se quiser saber sobre amea√ßas, t√¥ afiado! Mas temperatura ainda n√£o √© comigo."
    ],
    "como est√° o tempo": [
        "Infelizmente n√£o consigo ver o clima l√° fora, s√≥ o clima virtual aqui! üå§Ô∏è",
        "Tempo? S√≥ se for o tempo de resposta dos meus alertas üòÅ",
        "Ainda n√£o sei o clima, mas posso te atualizar sobre amea√ßas digitais!"
    ]
}

def resposta_varias(opcoes):
    return random.choice(opcoes)

def responder(msg):
    print(f"üõ°Ô∏è  Aegis: {msg}")
    historico.append({"bot": msg})
    if len(historico) > 20:
        historico.pop(0)

def verificar_basico(pergunta):
    pergunta_low = pergunta.lower().strip()
    for chave, respostas in respostas_basicas.items():
        if chave in pergunta_low:
            return resposta_varias(respostas)
    if any(x in pergunta_low for x in ["oi", "ol√°", "bom dia", "boa tarde", "boa noite"]):
        return resposta_varias(cumprimentos)
    if any(x in pergunta_low for x in ["tchau", "adeus", "at√© mais", "falou", "at√© logo"]):
        return resposta_varias(despedidas)
    return None

def fuzzy_search(query, data, key):
    termos = [item.get(key, "") for item in data]
    if not termos:
        return None, None
    match, score, idx = process.extractOne(query, termos, scorer=fuzz.token_sort_ratio)
    if score > 70:
        return data[idx], score
    return None, None

def buscar_resposta_faq(pergunta):
    perguntas = [item["pergunta"] for item in faq]
    if not perguntas:
        return None
    match, score, idx = process.extractOne(pergunta, perguntas, scorer=fuzz.token_sort_ratio)
    if score > 80:
        return faq[idx]["resposta"]
    return None

def pesquisar_google(query, num=2):
    links = []
    if search:
        try:
            for url in search(query, num_results=num, lang="pt"):
                links.append(url)
        except Exception as e:
            links.append(f"Erro ao pesquisar no Google: {e}")
    else:
        links.append("Nenhuma biblioteca de pesquisa instalada.")
    return links

def acionar_equipe_aegis(prioridade, resumo_situacao):
    numero = "+5514996609040"
    mensagem = f"""‚ö†Ô∏è Alerta Aegis [{prioridade.upper()} PRIORIDADE]:
Usu√°rio solicitou atendimento presencial.

Resumo da situa√ß√£o:
{resumo_situacao}

Por favor, entrem em contato imediatamente conforme o n√≠vel de prioridade."""
    agora = datetime.now()
    hora = agora.hour
    minuto = agora.minute + 1
    kit.sendwhatmsg(numero, mensagem, hora, minuto, wait_time=10, tab_close=True)

def formatar_resumo_para_formal(situacao):
    resumo = situacao.strip().capitalize()
    frases = resumo.split('.')
    frases = [f.strip().capitalize() for f in frases if f.strip()]
    return '. '.join(frases) + '.'

emergencia_keywords = ["emerg√™ncia", "socorro", "urgente", "atendimento presencial", "acidente", "chame a equipe", "preciso de ajuda presencial"]

saudacoes = [
    "Oi! Sou o Aegis üõ°Ô∏è, especialista em ciberseguran√ßa. Pergunte sobre amea√ßas, golpes, prote√ß√£o ou d√∫vidas de tecnologia!",
    "Ol√°! Posso explicar riscos, analisar suspeitas, sugerir boas pr√°ticas e te orientar em emerg√™ncias digitais.",
    "E a√≠! Sou expert em seguran√ßa virtual, pronto pra proteger voc√™ e sua loja. O que precisa saber?"
]
respostas_nao_sei = [
    "Essa n√£o sei de cabe√ßa, mas estou pesquisando pra voc√™!",
    "Ainda n√£o sei responder isso, mas vou buscar a melhor resposta.",
    "N√£o tenho certeza, mas vou pesquisar na internet pra te ajudar."
]

responder(resposta_varias(saudacoes))
ultima_pergunta_sem_resposta = None

while True:
    user = input("Voc√™: ").strip()
    if not user:
        continue
    historico.append({"user": user})
    if len(historico) > 20:
        historico.pop(0)

    # Despedida
    if any(x in user.lower() for x in ["sair", "exit", "quit", "tchau", "adeus"]):
        responder(resposta_varias(despedidas))
        break

    # Emerg√™ncia
    if any(kw in user.lower() for kw in emergencia_keywords):
        responder("Entendi que voc√™ pode precisar de atendimento presencial.")
        responder("Qual o n√≠vel de prioridade do seu pedido?\n[1] Baixo\n[2] M√©dio\n[3] Alto")
        prioridade_map = {"1": "Baixo", "2": "M√©dio", "3": "Alto"}
        prioridade = ""
        while prioridade not in prioridade_map:
            prioridade = input("Escolha o n√≠vel de prioridade (1/2/3): ").strip()
        prioridade_str = prioridade_map[prioridade]
        responder(f"Por favor, explique brevemente a situa√ß√£o. Quanto mais detalhes, melhor para a equipe atender:")
        situacao = input("Explique a situa√ß√£o: ").strip()
        resumo_formal = formatar_resumo_para_formal(situacao)
        if prioridade_str == "Alto":
            responder("Situa√ß√£o entendida como ALTA PRIORIDADE. Estou acionando a equipe Aegis agora mesmo!")
            acionar_equipe_aegis(prioridade_str, resumo_formal)
            responder("Equipe notificada. Em breve algu√©m deve entrar em contato. Precisa de mais alguma coisa?")
        else:
            responder(f"Voc√™ marcou prioridade {prioridade_str}. Confirma o envio do chamado √† equipe? (sim/n√£o)")
            confirma = input("Voc√™: ").strip().lower()
            if confirma in ["sim", "s", "confirmo"]:
                responder("Chamado enviado √† equipe Aegis!")
                acionar_equipe_aegis(prioridade_str, resumo_formal)
                responder("Equipe notificada. Precisa de mais alguma coisa?")
            else:
                responder("Ok, n√£o acionei a equipe. Posso ajudar de outra forma?")
        continue

    # Respostas b√°sicas
    resposta_basico = verificar_basico(user)
    if resposta_basico:
        responder(resposta_basico)
        ultima_pergunta_sem_resposta = None
        continue

    # Perguntas sobre amea√ßas
    ameaca, score_a = fuzzy_search(user, ameacas, "Amea√ßas")
    if ameaca:
        responder(f"Sobre '{ameaca['Amea√ßas']}':\n{ameaca['Explica√ß√µes das Amea√ßas']}\nSolu√ß√£o recomendada: {ameaca['Solu√ß√µes']}")
        responder("Se quiser exemplos, dicas de prote√ß√£o ou saber como agir, √© s√≥ pedir!")
        ultima_pergunta_sem_resposta = None
        responder("Posso ajudar em mais alguma coisa? üòä")
        continue

    # Perguntas sobre sites maliciosos
    site, score_s = fuzzy_search(user, sites, "URL")
    if site:
        responder(f"Cuidado! O site {site['URL']} √© malicioso: {site['Descri√ß√£o']}")
        ultima_pergunta_sem_resposta = None
        responder("Mais alguma d√∫vida ou posso ajudar com outra coisa?")
        continue

    # Perguntas sobre logs
    if "hoje" in user.lower() or "recentes" in user.lower():
        hoje = datetime.now().strftime("%d/%b/%Y")
        logs_hoje = [l for l in logs if l.get("Data") == hoje]
        if logs_hoje:
            responder(f"Foram detectados {len(logs_hoje)} eventos hoje:")
            for log in logs_hoje[:5]:
                responder(f"- {log['Hora']} | IP: {log['IP Atacante']} | {', '.join(log['T√≠tulos do Ataque'])}")
            if len(logs_hoje) > 5:
                responder(f"...e mais {len(logs_hoje)-5} eventos! Quer ver tudo?")
        else:
            responder("Por enquanto, tudo tranquilo nos registros de hoje.")
        ultima_pergunta_sem_resposta = None
        responder("Posso ajudar em mais alguma coisa? üòä")
        continue

    # Busca no FAQ
    resposta_faq = buscar_resposta_faq(user)
    if resposta_faq:
        responder(resposta_faq)
        ultima_pergunta_sem_resposta = None
        responder("Se quiser saber mais, s√≥ perguntar! üòÅ")
        continue

    # Pesquisa Google se n√£o souber
    responder(resposta_varias(respostas_nao_sei))
    links_achados = pesquisar_google(user, num=2)
    if links_achados and links_achados[0]:
        responder("Pesquisei na web pra voc√™, olha s√≥ o que achei:")
        for link in links_achados:
            responder(link)
    else:
        responder("N√£o encontrei nada relevante nas buscas, mas se quiser pode tentar perguntar de outro jeito!")

    ultima_pergunta_sem_resposta = user
    responder("Precisa de mais alguma coisa? Se sim, pode perguntar! üòâ")